name: Leak Scan

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  leak-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for secrets and internal data
        shell: bash
        run: |
          set -e

          echo "Scanning for internal URLs..."
          if grep -R -n -E "https?://[^ ]+\.cfolino\.com" .; then
            echo "ERROR: internal URL detected"
            exit 1
          fi

          echo "Scanning for internal email addresses..."
          if grep -R -n -E "[A-Za-z0-9._%+-]+@cfolino\.com" .; then
            echo "ERROR: internal email detected"
            exit 1
          fi

          echo "Scanning for raw RFC1918 IPs (numeric only)..."
          if grep -R -n -E "192\.168\.[0-9]{1,3}\.[0-9]{1,3}" .; then
            echo "ERROR: raw 192.168 IP detected"
            exit 1
          fi
          if grep -R -n -E "10\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" .; then
            echo "ERROR: raw 10.x IP detected"
            exit 1
          fi
          if grep -R -n -E "172\.(1[6-9]|2[0-9]|3[0-1])\.[0-9]{1,3}\.[0-9]{1,3}" .; then
            echo "ERROR: raw 172.16-31 IP detected"
            exit 1
          fi

          echo "Scanning for unredacted disk UUIDs..."
          if grep -R -n -E "dev-disk-by-uuid-[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}" .; then
            echo "ERROR: unredacted UUID detected"
            exit 1
          fi

          echo "Scanning for bearer tokens..."
          if grep -R -n -E "Bearer\s+[A-Za-z0-9\-_\.=]+" .; then
            echo "ERROR: bearer token detected"
            exit 1
          fi

          echo "Scanning for private keys..."
          if grep -R -n -E "BEGIN .*PRIVATE KEY" .; then
            echo "ERROR: private key material detected"
            exit 1
          fi

          echo "Leak scan completed successfully"
