name: Leak Scan (Sanitized Docs)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  leak-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Detect actual private key material, not documentation references
      - name: Scan for private key material
        run: |
          if grep -R -n -E "BEGIN ([A-Z ]+ )?PRIVATE KEY" . \
            | grep -vE "\.(md|txt)"; then
            echo "Private key material detected outside documentation"
            exit 1
          fi

      - name: Scan for internal domains
        run: |
          if grep -R -n -E "cfolino\.com" .; then
            echo "Internal domain leakage detected"
            exit 1
          fi

      - name: Scan for internal email addresses
        run: |
          if grep -R -n -E "@cfolino\.com" . \
            | grep -v "<redacted-email>"; then
            echo "Internal email leakage detected"
            exit 1
          fi

      - name: Scan for raw RFC1918 IPs
        run: |
          if grep -R -n -E "192\.168\.[0-9]{1,3}\.[0-9]{1,3}" .; then
            echo "Unsanitized 192.168.x.x IP detected"
            exit 1
          fi

          if grep -R -n -E "10\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" .; then
            echo "Unsanitized 10.x.x.x IP detected"
            exit 1
          fi

          if grep -R -n -E "172\.(1[6-9]|2[0-9]|3[0-1])\.[0-9]{1,3}\.[0-9]{1,3}" .; then
            echo "Unsanitized 172.16â€“31.x.x IP detected"
            exit 1
          fi

      - name: Scan for common cloud and API tokens
        run: |
          if grep -R -n -E "AKIA[0-9A-Z]{16}" .; then
            echo "AWS access key detected"
            exit 1
          fi

          if grep -R -n -E "AIza[0-9A-Za-z\-_]{35}" .; then
            echo "Google API key detected"
            exit 1
          fi

      - name: Scan for bearer tokens
        run: |
          if grep -R -n -E "Bearer\s+[A-Za-z0-9\-_\.=]+" .; then
            echo "Bearer token detected"
            exit 1
          fi

      - name: Leak scan passed
        run: echo "Leak scan completed successfully"
