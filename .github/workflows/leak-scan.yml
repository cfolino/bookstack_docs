name: Leak Scan

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  leak-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for secrets and internal data
        shell: bash
        run: |
          set -e

          echo "Scanning for internal domains..."
          if grep -R -n "cfolino.com" . \
            | grep -v "<internal-domain>" \
            | grep -v "<redacted>"; then
            echo "ERROR: internal domain detected"
            exit 1
          fi

          echo "Scanning for internal email addresses..."
          if grep -R -n -E "[A-Za-z0-9._%+-]+@cfolino\.com" . \
            | grep -v "<redacted-email>"; then
            echo "ERROR: internal email detected"
            exit 1
          fi

          echo "Scanning for raw RFC1918 IPs (numeric only)..."
          if grep -R -n -E "(192\.168\.[0-9]{1,3}\.[0-9]{1,3}|10\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}|172\.(1[6-9]|2[0-9]|3[0-1])\.[0-9]{1,3}\.[0-9]{1,3})" .; then
            echo "ERROR: raw internal IP detected"
            exit 1
          fi

          echo "Scanning for unredacted disk UUIDs..."
          if grep -R -n -E "dev-disk-by-uuid-[a-f0-9-]{8,}" . \
            | grep -v "<uuid-redacted>"; then
            echo "ERROR: unredacted UUID detected"
            exit 1
          fi

          echo "Scanning for bearer tokens..."
          if grep -R -n -E "Bearer[[:space:]]+[A-Za-z0-9\-_\.=]+" . \
            | grep -v "<redacted>"; then
            echo "ERROR: bearer token detected"
            exit 1
          fi

          echo "Scanning for private keys (excluding docs)..."
          if grep -R -n -E "BEGIN .*PRIVATE KEY" . \
            | grep -v "```" \
            | grep -v "<example>" \
            | grep -v "<redacted>"; then
            echo "ERROR: private key material detected"
            exit 1
          fi

          echo "Leak scan completed successfully"
