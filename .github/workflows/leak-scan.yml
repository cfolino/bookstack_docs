name: Leak Scan

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  leak-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for secrets and internal data
        shell: bash
        run: |
          set -e

          echo "Scanning for internal domains..."
          if grep -R -n "cfolino.com" .; then
            echo "ERROR: internal domain detected"
            exit 1
          fi

          echo "Scanning for RFC1918 IPs..."
          if grep -R -n -E "192\.168\.[0-9]{1,3}\.[0-9]{1,3}" .; then
            echo "ERROR: internal IP detected"
            exit 1
          fi
          if grep -R -n -E "10\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" .; then
            echo "ERROR: internal IP detected"
            exit 1
          fi
          if grep -R -n -E "172\.(1[6-9]|2[0-9]|3[0-1])\.[0-9]{1,3}\.[0-9]{1,3}" .; then
            echo "ERROR: internal IP detected"
            exit 1
          fi

          echo "Scanning for UUID-backed disk paths..."
          if grep -R -n "dev-disk-by-uuid-" .; then
            echo "ERROR: unredacted UUID detected"
            exit 1
          fi

          echo "Scanning for bearer tokens..."
          if grep -R -n -E "Bearer\s+[A-Za-z0-9\-_\.=]+" .; then
            echo "ERROR: bearer token detected"
            exit 1
          fi

          echo "Scanning for common secret keywords..."
          if grep -R -n -E "(password|passwd|secret|token|apikey|api_key|authorization)" .; then
            echo "ERROR: potential secret detected"
            exit 1
          fi

          echo "Leak scan completed successfully"
